name: ğŸ§© Check PR File Rules

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: files
        run: |
          FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate file naming and content
        id: validate
        run: |
          echo "ğŸ” å¼€å§‹æ£€æŸ¥æ–‡ä»¶..."
          ERROR_MSG=""
          VALID_PATTERN="^2025413[0-9]{3}\\.md$"

          for FILE in ${{ steps.files.outputs.files }}; do
            echo "æ£€æŸ¥æ–‡ä»¶: $FILE"

            # æ£€æŸ¥å‘½å
            if ! [[ "$FILE" =~ $VALID_PATTERN ]]; then
              ERROR_MSG+="âŒ æ–‡ä»¶åä¸ç¬¦åˆè¦æ±‚: $FILEï¼ˆå¿…é¡»ä¸ºå½¢å¦‚ 2025413XXX.md çš„å­¦å·æ–‡ä»¶ï¼‰\n"
              continue
            fi

            # æ£€æŸ¥æ‰©å±•å
            if [[ "${FILE##*.}" != "md" ]]; then
              ERROR_MSG+="âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯: $FILEï¼ˆå¿…é¡»æ˜¯ .md æ–‡ä»¶ï¼‰\n"
              continue
            fi

            # æ£€æŸ¥ YAML Front Matter
            if ! grep -q '^---' "$FILE"; then
              ERROR_MSG+="âŒ ç¼ºå°‘ YAML Front Matter å¼€å¤´: $FILE\n"
              continue
            fi

            REQUIRED_FIELDS=("title:" "date:" "tags:" "copyright_author:")
            for FIELD in "${REQUIRED_FIELDS[@]}"; do
              if ! grep -q "$FIELD" "$FILE"; then
                ERROR_MSG+="âŒ YAML ç¼ºå°‘å­—æ®µ $FIELD: $FILE\n"
              fi
            done

            # æ£€æŸ¥æ—¥æœŸæ ¼å¼
            DATE=$(grep "^date:" "$FILE" | awk '{print $2, $3}')
            if ! echo "$DATE" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}$'; then
              ERROR_MSG+="âŒ date æ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä¸º YYYY-MM-DD HH:MM:SSï¼‰: $FILE\n"
            fi
          done

          if [ -n "$ERROR_MSG" ]; then
            echo "æ£€æŸ¥æœªé€šè¿‡"
            # è¾“å‡ºåˆ° step output
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¬¦åˆè¦æ±‚ã€‚"
          fi

      - name: Comment on PR if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr = context.payload.pull_request;
            const errorMessage = '${{ steps.validate.outputs.error_message }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `ğŸš« **è‡ªåŠ¨æ£€æŸ¥æœªé€šè¿‡ï¼š**\n\n${errorMessage}`
            });

      - name: Close PR if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr = context.payload.pull_request;
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              state: "closed"
            });
            console.log("âŒ PR å·²è¢«è‡ªåŠ¨å…³é—­ã€‚");
