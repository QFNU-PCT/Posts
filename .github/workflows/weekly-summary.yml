name: Weekly Submission Summary

on:
  schedule:
    # æ¯å‘¨å…­ä¸­åˆ 12:00 (UTC+8)
    - cron: "0 4 * * 6"  # UTC+4 = åŒ—äº¬æ—¶é—´12ç‚¹
  workflow_dispatch:  # å¯æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y gh jq

      - name: Collect submissions from commits in last 7 days
        id: collect
        run: |
          echo "ğŸ“Š æ”¶é›†æœ€è¿‘ 7 å¤©çš„æäº¤è®°å½•..."
          since=$(date -u -d "-7 days" +"%Y-%m-%dT%H:%M:%SZ")
          commits=$(gh api repos/${{ github.repository }}/commits --paginate -q ".[] | select(.commit.author.date > \"$since\") | .files? // [] | .[]?.filename" || true)

          if [ -z "$commits" ]; then
            echo "æ²¡æœ‰æ–°æäº¤"
            echo "result=None" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æå–å­¦å·
          ids=$(echo "$commits" | grep -Eo '2025413[0-9]{3}\.md' | sed 's/\.md//' | sort -u)
          if [ -z "$ids" ]; then
            echo "result=None" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "æœ¬å‘¨æäº¤å­¦å·:"
          echo "$ids"
          echo "result=$ids" >> $GITHUB_OUTPUT

      - name: Post weekly summary comment
        if: steps.collect.outputs.result != 'None'
        run: |
          ids="${{ steps.collect.outputs.result }}"
          week=$(date +'%Y-%m-%d')
          body="ğŸ“š **${week} æœ¬å‘¨æäº¤ç¬”è®°çš„å­¦å·åå•**\n\n"
          body+="| åºå· | å­¦å· |\n|------|------|\n"
          i=1
          for id in $ids; do
            body+="| $i | $id |\n"
            ((i++))
          done

          gh issue list --search "æ¯å‘¨ç¬”è®°ç»Ÿè®¡" --limit 1 --json number | jq -r '.[0].number' > issue.txt || true
          issue_num=$(cat issue.txt)
          if [ "$issue_num" = "null" ] || [ -z "$issue_num" ]; then
            gh issue create --title "ğŸ“… æ¯å‘¨ç¬”è®°ç»Ÿè®¡" --body "$body"
          else
            gh issue comment "$issue_num" --body "$body"
          fi
