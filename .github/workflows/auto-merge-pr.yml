name: ğŸ“ è‡ªåŠ¨å®¡æ ¸ä¸åˆå¹¶ç¬”è®° PR

on:
  pull_request:
    types: [opened, reopened, synchronize]
  schedule:
    - cron: '0 4 * * 6'  # æ¯å‘¨å…­ä¸­åˆ12:00 (UTC+8)ï¼ŒUTCæ—¶é—´ä¸º04:00
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£… jq
        run: sudo apt-get install -y jq

      - name: è·å– PR æ–‡ä»¶åˆ—è¡¨
        id: files
        run: |
          files=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')
          echo "files<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: æ£€æŸ¥æ–‡ä»¶æ ¼å¼
        id: check
        run: |
          valid=true
          message=""
          for file in $files; do
            filename=$(basename "$file")
            if [[ ! $filename =~ ^2025413[0-9]{3}\.md$ ]]; then
              valid=false
              message+="âŒ æ–‡ä»¶åä¸ç¬¦åˆè¦æ±‚: $filename\n"
              continue
            fi
            if [[ ! -f "$file" ]]; then
              valid=false
              message+="âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file\n"
              continue
            fi
            # æ£€æŸ¥ YAML å¤´
            header=$(head -n 10 "$file")
            if ! echo "$header" | grep -q "^---"; then
              valid=false
              message+="âŒ æ–‡ä»¶ç¼ºå°‘ YAML å¤´: $filename\n"
              continue
            fi
            if ! echo "$header" | grep -q "title:"; then
              valid=false
              message+="âŒ YAML ç¼ºå°‘ title å­—æ®µ: $filename\n"
            fi
            if ! echo "$header" | grep -q "date:"; then
              valid=false
              message+="âŒ YAML ç¼ºå°‘ date å­—æ®µ: $filename\n"
            fi
            if ! echo "$header" | grep -q "tags: ç¬”è®°"; then
              valid=false
              message+="âŒ YAML ç¼ºå°‘ tags: ç¬”è®°: $filename\n"
            fi
            if ! echo "$header" | grep -q "copyright_author:"; then
              valid=false
              message+="âŒ YAML ç¼ºå°‘ copyright_author å­—æ®µ: $filename\n"
            fi
          done

          echo "valid=$valid" >> $GITHUB_ENV
          echo "message=$message" >> $GITHUB_ENV

      - name: å¤„ç†ç»“æœ
        run: |
          if [[ "$valid" == "true" ]]; then
            echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡ï¼Œè‡ªåŠ¨åˆå¹¶ PR"
            gh pr merge ${{ github.event.pull_request.number }} --merge --auto --delete-branch
          else
            echo -e "$message"
            gh pr comment ${{ github.event.pull_request.number }} --body "$message"
            gh pr close ${{ github.event.pull_request.number }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  weekly-report:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è¾“å‡ºæœ¬å‘¨æäº¤å­¦å·
        run: |
          echo "ğŸ“˜ æœ¬å‘¨æäº¤çš„å­¦å·åˆ—è¡¨ï¼š"
          git log --since="7 days ago" --pretty=format: --name-only \
            | grep '^2025413[0-9]\{3\}\.md$' | sort | uniq \
            | sed 's/\.md//' || echo "æš‚æ— æäº¤"
