name: Auto Check & Merge Study Notes PR

on:
  # ä½¿ç”¨ pull_request_target è€Œé pull_requestï¼Œè¿™æ˜¯è§£å†³æƒé™é—®é¢˜çš„å…³é”®
  pull_request_target:
    types: [opened, reopened, synchronize]

# è®¾ç½®å·¥ä½œæµçº§åˆ«æƒé™
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-and-merge:
    # ğŸ”’ é‡è¦å®‰å…¨æªæ–½ï¼šåªå¤„ç†æ¥è‡ªæœ¬ä»“åº“çš„ PRï¼Œé¿å…æ‰§è¡Œä¸å—ä¿¡ä»»çš„ä»£ç 
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»£ç ï¼ˆå®‰å…¨åœ°æ£€å‡º PR çš„æäº¤ï¼Œè€Œéåˆ†æ”¯ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # å…³é”®å®‰å…¨è®¾ç½®

      # 2ï¸âƒ£ é…ç½® GitHub CLI
      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "é…ç½® GitHub CLI èº«ä»½éªŒè¯"
          gh auth status

      # 3ï¸âƒ£ éªŒè¯ PR æ–‡ä»¶ï¼ˆæ ¸å¿ƒéªŒè¯é€»è¾‘ï¼‰
      - name: Validate PR files
        id: validate
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å¼€å§‹æ£€æŸ¥ PR #$PR_NUMBER"

          # è·å– PR æ–‡ä»¶åˆ—è¡¨
          PR_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path')
          echo "æ£€æµ‹åˆ°æ–‡ä»¶: $PR_FILES"

          VALID=true
          ERRORS=""

          for FILE in $PR_FILES; do
            echo "æ£€æŸ¥æ–‡ä»¶: $FILE"
            BASENAME=$(basename "$FILE")

            # æ£€æŸ¥æ‰©å±•å
            if [[ ! $FILE =~ \.md$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** ä¸æ˜¯ Markdown (.md) æ–‡ä»¶\n"
              VALID=false
              continue
            fi

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$FILE" ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** åœ¨ä»“åº“ä¸­ä¸å­˜åœ¨\n"
              VALID=false
              continue
            fi

            # æ–‡ä»¶åæ ¼å¼éªŒè¯
            if [[ ! $BASENAME =~ ^2025413[0-9]{3}\.md$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶åä¸ç¬¦åˆè¦æ±‚: **$FILE**ï¼Œåº”ä¸º 2025413xxxx.md\n"
              VALID=false
            fi

            # æ£€æŸ¥ YAML å¤´
            if ! head -n 10 "$FILE" | grep -q "^---"; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** ç¼ºå°‘ YAML å¤´éƒ¨ '---'\n"
              VALID=false
            fi

            HEAD_CONTENT=$(head -n 10 "$FILE")

            # å¿…å¤‡å­—æ®µæ£€æŸ¥
            for key in title date tags copyright_author; do
              if ! echo "$HEAD_CONTENT" | grep -q "$key:"; then
                ERRORS+="âŒ æ–‡ä»¶ **$FILE** YAML ç¼ºå°‘å­—æ®µï¼š\`$key\`\n"
                VALID=false
              fi
            done

            # æ£€æŸ¥ tags
            if ! echo "$HEAD_CONTENT" | grep -q "tags: *ç¬”è®°"; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ tags å¿…é¡»ä¸º 'ç¬”è®°'\n"
              VALID=false
            fi

            # æ£€æŸ¥ copyright_author
            AUTHOR=$(echo "$HEAD_CONTENT" | grep "copyright_author:" | awk -F': ' '{print $2}' | tr -d '\r' | tr -d ' ')
            if [[ -z "$AUTHOR" ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author ä¸ºç©º\n"
              VALID=false
            elif [[ $AUTHOR =~ ^[0-9]{10}$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author ä¸åº”ä¸ºå­¦å·\n"
              VALID=false
            elif [[ ! $AUTHOR =~ ^[A-Za-z0-9_ä¸€-é¾¥]+$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author å«æœ‰éæ³•å­—ç¬¦ï¼Œåªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿æˆ–ä¸­æ–‡\n"
              VALID=false
            fi
          done

          echo "validation_result=$VALID" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" > errors.txt
          echo "éªŒè¯å®Œæˆ: $VALID"

      # 4ï¸âƒ£ PR ä¸åˆæ ¼ â†’ è‡ªåŠ¨è¯„è®º + è‡ªåŠ¨å…³é—­
      - name: Comment and close invalid PR
        if: steps.validate.outputs.validation_result == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR æœªé€šè¿‡éªŒè¯ï¼Œå‡†å¤‡è¯„è®ºå¹¶å…³é—­..."
          COMMENT_BODY="âš ï¸ **æ‚¨çš„ PR æœªé€šè¿‡è‡ªåŠ¨æ£€æŸ¥ï¼Œå·²è‡ªåŠ¨å…³é—­ã€‚è¯·ä¿®æ”¹åé‡æ–°æäº¤ã€‚**\n\n"
          COMMENT_BODY+="ä»¥ä¸‹æ˜¯æ£€æµ‹åˆ°çš„é—®é¢˜ï¼š\n\n$(cat errors.txt)\n\n"
          COMMENT_BODY+="âœ… **å‚è€ƒæ­£ç¡®æ ¼å¼ï¼š**\n\n\`\`\`yaml\n"
          COMMENT_BODY+="---\n"
          COMMENT_BODY+="title: ç¤ºä¾‹æ ‡é¢˜\n"
          COMMENT_BODY+="date: 2025-10-31 17:43:20\n"
          COMMENT_BODY+="tags: ç¬”è®°\n"
          COMMENT_BODY+="copyright_author: ä½ çš„å§“å\n"
          COMMENT_BODY+="---\n\`\`\`\n\n"
          COMMENT_BODY+="ğŸ“˜ æ–‡ä»¶åç¤ºä¾‹ï¼š\`2025413047.md\`\n\n"
          COMMENT_BODY+="ğŸ’¡ **ä¿®æ”¹å»ºè®®ï¼š**\n"
          COMMENT_BODY+="1. ç¡®ä¿æ–‡ä»¶æ‰©å±•åä¸º .md\n"
          COMMENT_BODY+="2. æ–‡ä»¶åæ ¼å¼ä¸º 2025413xxxx.md\n"
          COMMENT_BODY+="3. åŒ…å«å®Œæ•´çš„ YAML å¤´éƒ¨ï¼ˆå‰åæœ‰ ---ï¼‰\n"
          COMMENT_BODY+="4. copyright_author å­—æ®µä½¿ç”¨çœŸå®å§“åè€Œéå­¦å·\n"

          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          gh pr close ${{ github.event.pull_request.number }} --comment "âŒ æœªé€šè¿‡æ ¼å¼æ£€æŸ¥ï¼Œè¯·æ ¹æ®æç¤ºä¿®æ”¹åé‡æ–°æäº¤ã€‚"

      # 5ï¸âƒ£ PR åˆæ ¼ â†’ è‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶
      - name: Approve and merge valid PR
        if: steps.validate.outputs.validation_result == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR é€šè¿‡éªŒè¯ï¼Œå‡†å¤‡æ‰¹å‡†å¹¶åˆå¹¶..."
          gh pr review ${{ github.event.pull_request.number }} --approve -b "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡ï¼Œè‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶ã€‚"
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch
