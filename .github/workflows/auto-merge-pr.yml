name: Auto Check & Merge Study Notes PR

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    steps:

      # 1ï¸âƒ£ æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ éªŒè¯ PR æ–‡ä»¶
      - name: Validate PR files
        id: validate
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "å¼€å§‹æ£€æŸ¥ PR #$PR_NUMBER"

          # è·å– PR æ–‡ä»¶åˆ—è¡¨
          PR_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path')
          echo "æ£€æµ‹åˆ°æ–‡ä»¶: $PR_FILES"

          VALID=true
          ERRORS=""

          for FILE in $PR_FILES; do
            BASENAME=$(basename "$FILE")

            # æ£€æŸ¥æ‰©å±•å
            if [[ ! $FILE =~ \.md$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** ä¸æ˜¯ Markdown (.md) æ–‡ä»¶\n"
              VALID=false
            fi

            # æ–‡ä»¶åæ ¼å¼ï¼šä»¥ 2025413 å¼€å¤´ + 10 ä½æ•°å­—
            if [[ ! $BASENAME =~ ^2025413[0-9]{3}\.md$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶åä¸ç¬¦åˆè¦æ±‚: **$FILE**ï¼Œåº”ä¸º 2025413xxxx.md\n"
              VALID=false
            fi

            # æ£€æŸ¥ YAML å¤´
            if ! head -n 10 "$FILE" | grep -q "^---"; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** ç¼ºå°‘ YAML å¤´éƒ¨ '---'\n"
              VALID=false
            fi

            HEAD_CONTENT=$(head -n 10 "$FILE")

            # å¿…å¤‡å­—æ®µæ£€æŸ¥
            for key in title date tags copyright_author; do
              if ! echo "$HEAD_CONTENT" | grep -q "$key:"; then
                ERRORS+="âŒ æ–‡ä»¶ **$FILE** YAML ç¼ºå°‘å­—æ®µï¼š\`$key\`\n"
                VALID=false
              fi
            done

            # æ£€æŸ¥ tags
            if ! echo "$HEAD_CONTENT" | grep -q "tags: *ç¬”è®°"; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ tags å¿…é¡»ä¸º 'ç¬”è®°'\n"
              VALID=false
            fi

            # æ£€æŸ¥ copyright_author
            AUTHOR=$(echo "$HEAD_CONTENT" | grep "copyright_author:" | awk -F': ' '{print $2}' | tr -d '\r')
            if [[ -z "$AUTHOR" ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author ä¸ºç©º\n"
              VALID=false
            elif [[ $AUTHOR =~ ^[0-9]{10}$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author ä¸åº”ä¸ºå­¦å·\n"
              VALID=false
            elif [[ ! $AUTHOR =~ ^[A-Za-z0-9_ä¸€-é¾¥]+$ ]]; then
              ERRORS+="âŒ æ–‡ä»¶ **$FILE** çš„ copyright_author å«æœ‰éæ³•å­—ç¬¦ï¼Œåªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿æˆ–ä¸­æ–‡\n"
              VALID=false
            fi
          done

          echo "validation=$VALID" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" > errors.txt

      # 3ï¸âƒ£ PR ä¸åˆæ ¼ â†’ è‡ªåŠ¨è¯„è®º + è‡ªåŠ¨å…³é—­
      - name: Comment and close invalid PR
        if: steps.validate.outputs.validation == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="âš ï¸ **æ‚¨çš„ PR æœªé€šè¿‡è‡ªåŠ¨æ£€æŸ¥ï¼Œè¯·ä¿®æ”¹åé‡æ–°æäº¤ã€‚**\n\n"
          COMMENT_BODY+="ä»¥ä¸‹æ˜¯æ£€æµ‹åˆ°çš„é—®é¢˜ï¼š\n\n$(cat errors.txt)\n\n"
          COMMENT_BODY+="âœ… **å‚è€ƒæ­£ç¡®æ ¼å¼ï¼š**\n\n\`\`\`yaml\n"
          COMMENT_BODY+="---\n"
          COMMENT_BODY+="title: ç¤ºä¾‹æ ‡é¢˜\n"
          COMMENT_BODY+="date: 2025-10-31 17:43:20\n"
          COMMENT_BODY+="tags: ç¬”è®°\n"
          COMMENT_BODY+="copyright_author: Alice\n"
          COMMENT_BODY+="---\n\`\`\`\n\n"
          COMMENT_BODY+="ğŸ“˜ æ–‡ä»¶åç¤ºä¾‹ï¼š\`2025413047.md\`\n"

          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          gh pr close ${{ github.event.pull_request.number }} --comment "âŒ æœªé€šè¿‡æ ¼å¼æ£€æŸ¥ï¼Œè¯·æ ¹æ®æç¤ºä¿®æ”¹åé‡æ–°æäº¤ã€‚"

      # 4ï¸âƒ£ PR åˆæ ¼ â†’ è‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶
      - name: Approve and merge valid PR
        if: steps.validate.outputs.validation == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve -b "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡ï¼Œè‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶ã€‚"
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch --auto
